<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Descripciones DJOYAS</title>
  <!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">



 <style>
  body {
    font-family: "Segoe UI", sans-serif;
    background-color: #f9f9f9;
    color: #333;
    padding: 2rem;
    max-width: 1100px;
    margin: auto;
  }
  h1 {
    color: #c49a6c;
  }
  input, button, textarea {
    width: 100%;
    padding: 0.6rem;
    margin: 0.5rem 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  button {
    background-color: #323232;
    color: white;
    border: none;
    cursor: pointer;
    transition: 0.3s;
  }
  .btn-outline-secondary {
    background-color: #fff !important;
    border: 1px solid #e1e1e1 !important;
  }
  .btn-outline-secondary:hover {
    color: #323232;
    background: #f1f1f1;
  }
  button:hover:not(:disabled) {
    background-color: #696969;
  }
  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  #output {
    background: #fff;
    border: 1px solid #dddddd;
    padding: 1rem;
    height: 1000px;
    overflow-y: scroll;
    white-space: pre-wrap;
    border-radius: 15px;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .modal-content {
    background: white;
    padding: 1.5rem;
    width: 90%;
    max-width: 600px;
    border-radius: 6px;
    box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3);
  }
  textarea {
    height: 500px;
  }
  .bar-header {
    background: #f1f1f1;
    padding: 2rem;
    border-radius: 15px;
    margin: 2rem 0rem;
  }
  .titulo-prev {
    padding: 1rem 0rem;
  }
  .btn-descargar {
    position: absolute;
    width: 300px;
    right: 25%;
    margin-top: 1.5rem;
  }
  .btn-ingresar{
    background: #f8f9fa;
    color: #323232;
    border: 1px solid #bbbbbb;
}
  
</style>

</head>
<body>
  <h1>Generador de Descripciones para DJOYAS</h1>
 <div class="row bar-header"> 
<div class="col-lg-5 col-12">
  <button class="btn-ingresar" onclick="openModal('modalKey')">Ingresar clave API</button>
  <input type="file" id="upload" accept=".csv, .xls, .xlsx" />
</div>
<div class="col-lg-2 col-12">
<div class=""><button class="btn-outline-secondary" id="editPrompt300">Resumen</button></div>
<div class=""><button class="btn-outline-secondary" id="editPrompt900">Descripcion</button></div>
</div>
  

<div class="col-lg-5 col-12">
  <button id="generate" disabled>Generar descripciones</button>
</div>
</div>
  <button class="btn-descargar" id="download" disabled>Descargar archivo</button>
  <div id="output">Esperando archivo...</div>

  <!-- Modales -->
  <div class="modal" id="modal300">
    <div class="modal-content">
      <h3>Editar Prompt 300</h3>
      <textarea id="prompt300"></textarea>
      <button onclick="closeModal('modal300')">Guardar y cerrar</button>
    </div>
  </div>

  <div class="modal" id="modal900">
    <div class="modal-content">
      <h3>Editar Prompt 900</h3>
      <textarea id="prompt900"></textarea>
      <button onclick="closeModal('modal900')">Guardar y cerrar</button>
    </div>
  </div>

  <div class="modal" id="modalKey">
    <div class="modal-content">
      <h3>Ingresar API Key de OpenAI</h3>
      <input type="text" id="apikey" placeholder="Pega tu clave API aquí" />
      <button onclick="saveApiKey()">Guardar clave</button>
      <button class="btn-outline-secondary" onclick="closeModal('modalKey')">Cerrar</button>
    </div>
  </div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  let apiKey = "";
  let products = [];
  let promptTemplate300 = `Genera una descripción breve para un producto de joyería. Tono cercano, cálido y profesional, como DJOYAS. Usa "ustedes", sin exagerar ni usar palabras como energía, poder, amuleto. Máximo 300 caracteres.\\n\\nNombre: {{name}}\\nCaracterísticas: {{caracteristicas}}`;

  let promptTemplate900 = `Crea una descripción extensa para joyería, con tono cercano, positivo y empático, alineado a DJOYAS. Usa "ustedes", evita energía/poder/lucha. Enfócate en el propósito y conexión. Máx 900 caracteres.\\n\\nNombre: {{name}}\\nCaracterísticas: {{caracteristicas}}`;

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("prompt300").value = promptTemplate300;
    document.getElementById("prompt900").value = promptTemplate900;

    document.getElementById("editPrompt300").onclick = () => openModal("modal300");
    document.getElementById("editPrompt900").onclick = () => openModal("modal900");
    document.getElementById("upload").addEventListener("change", handleFileUpload);
    document.getElementById("generate").addEventListener("click", generateDescriptions);
    document.getElementById("download").addEventListener("click", exportToXLSX);
  });

  function openModal(id) {
    document.getElementById(id).style.display = "flex";
  }

  function closeModal(id) {
    document.getElementById(id).style.display = "none";
    if (id === "modal300") promptTemplate300 = document.getElementById("prompt300").value;
    if (id === "modal900") promptTemplate900 = document.getElementById("prompt900").value;
  }

  function saveApiKey() {
    apiKey = document.getElementById("apikey").value.trim();
    alert("API Key guardada correctamente.");
    closeModal("modalKey");
  }

  function handleFileUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    const ext = file.name.split(".").pop().toLowerCase();

    if (ext === "csv") {
      reader.onload = function (e) {
        const text = e.target.result;
        const separator = text.includes(";") ? ";" : ",";
        const rows = text.split("\\n").map(r => r.split(separator));
        const headers = rows[0];
        products = rows.slice(1).map(r =>
          headers.reduce((obj, h, i) => {
            obj[h.trim()] = r[i]?.trim();
            return obj;
          }, {})
        );
        document.getElementById("output").textContent = `Archivo CSV cargado: ${products.length} productos.`;
        document.getElementById("generate").disabled = false;
      };
      reader.readAsText(file);
    } else if (ext === "xls" || ext === "xlsx") {
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.SheetNames[0];
        products = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
        document.getElementById("output").textContent = `Archivo Excel cargado: ${products.length} productos.`;
        document.getElementById("generate").disabled = false;
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert("Formato no compatible. Usa .csv, .xls o .xlsx");
    }
  }

  async function generateDescriptions() {
    if (!apiKey || products.length === 0) {
      alert("Falta la API Key o no hay productos cargados.");
      return;
    }

    document.getElementById("generate").disabled = true;
    document.getElementById("output").textContent = "Procesando descripciones...";

    for (let i = 0; i < products.length; i++) {
      const p = products[i];
      const name = p.name || "";
      const caract = p.caracteristicas || "";

      const prompt300 = promptTemplate300.replace("{{name}}", name).replace("{{caracteristicas}}", caract);
      const prompt900 = promptTemplate900.replace("{{name}}", name).replace("{{caracteristicas}}", caract);

      p.resumen = await getOpenAIResponse(prompt300);
      p.descripcion = await getOpenAIResponse(prompt900);

      document.getElementById("output").textContent = `Procesando ${i + 1} / ${products.length}`;
    }

    document.getElementById("download").disabled = false;
    document.getElementById("output").textContent = "Descripciones generadas. ¡Listo para descargar!";
    renderPreview();
  }

  async function getOpenAIResponse(prompt) {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }],
        temperature: 0.7,
        max_tokens: 500,
      }),
    });

    const data = await res.json();
    return data.choices?.[0]?.message?.content?.trim() || "";
  }

  function exportToXLSX() {
    const worksheet = XLSX.utils.json_to_sheet(products);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Productos");
    XLSX.writeFile(workbook, "productos_con_descripciones.xlsx");
  }

  function renderPreview() {
    const output = document.getElementById("output");
    if (products.length === 0) {
      output.innerHTML = "<p>No hay productos para mostrar.</p>";
      return;
    }

    const headers = Object.keys(products[0]);
    let html = "<h3>Previsualización del archivo final</h3>";
    html += "<table border='1' cellpadding='6' style='width:100%; border-collapse:collapse; font-size: 14px;'>";
    html += "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead><tbody>";

    products.forEach(p => {
      html += "<tr>" + headers.map(h => `<td>${p[h] ?? ""}</td>`).join("") + "</tr>";
    });

    html += "</tbody></table>";
    output.innerHTML = html;
  }
</script>






</body>
</html>
